{% extends "base.html" %}
{% block title %}Event Registrations - EventEase{% endblock %}

{% block content %}
<div class="container">
    <h2 class="my-3">Event Registrations</h2>

    <!-- Filter Form -->
    <form method="GET" class="form-inline mb-3" onsubmit="return validateFilterForm()">
        <select name="event_id" class="form-control mr-2">
            <option value="">All Events</option>
            {% for event in events %}
                <option value="{{ event.id }}" {% if event.id == event_id %}selected{% endif %}>{{ event.title }}</option>
            {% endfor %}
        </select>

        <select name="status" class="form-control mr-2">
            <option value="">All Statuses</option>
            <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
            <option value="approved" {% if status == 'approved' %}selected{% endif %}>Approved</option>
        </select>

        <input type="text" name="search" id="searchInput" class="form-control mr-2" placeholder="Search user..." value="{{ search or '' }}">
        <button type="submit" class="btn btn-primary mr-2">Filter</button>
        <a href="{{ url_for('registrations', export='csv', event_id=event_id, status=status, search=search) }}" class="btn btn-success">Export CSV</a>
    </form>

    <script>
        function validateFilterForm() {
            const searchInput = document.getElementById('searchInput').value.trim();
            if (searchInput !== "" && searchInput.length < 2) {
                alert("Search term must be at least 2 characters.");
                return false;
            }
            return true;
        }
    </script>

    {% if registrations %}
    <table class="table table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>ID</th>
                <th>User</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Event</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for reg in registrations %}
            <tr>
                <td>{{ reg.id }}</td>
                <td>{{ reg.user_name }}</td>
                <td>{{ reg.user_email }}</td>
                <td>{{ reg.user_phone }}</td>
                <td>{{ reg.event_title }}</td>
                <td>
                    {% if reg.status == 'approved' %}
                        <span class="badge badge-success">Approved</span>
                    {% elif reg.status == 'pending' %}
                        <span class="badge badge-warning">Pending</span>
                    {% else %}
                        <span class="badge badge-secondary">{{ reg.status }}</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('approve_registration', reg_id=reg.id) }}" class="btn btn-success btn-sm">Approve</a>
                    <form method="POST" action="{{ url_for('delete_registration', reg_id=reg.id) }}" style="display:inline;">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?')">üóëÔ∏è Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <div class="d-flex justify-content-center">
        {{ pagination.links }}
    </div>
    {% else %}
        <p>No registrations found.</p>
    {% endif %}
</div>
{% endblock %}
